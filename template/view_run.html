
<div class="piln-actions">
  <a class="piln-btn" href="/home">Home</a>

  <a class="piln-btn piln-btn-secondary"
     href="/editcopy?run_id={{ run_id }}&state={{ state }}&notes={{ notes|urlencode }}">Copy to New Profile</a>

  <a class="piln-btn piln-btn-danger"
     href="/del_conf?run_id={{ run_id }}&state={{ state }}&notes={{ notes|urlencode }}">Delete Profile</a>

  <!-- Stop run is a POST -->
  <form class="form-inline" method="post" action="/stop">
    <input type="hidden" name="run_id" value="{{ run_id }}">
    <button type="submit" class="piln-btn piln-btn-danger">Stop Run</button>
  </form>
</div>

{% if message %}<p>{{ message }}</p>{% endif %}

<h2>Segments for {{ state }} Profile {{ run_id }}</h2>

<form class="form-inline mt-2" method="post" action="/notes_save">
  <input type="hidden" name="run_id" value="{{ run_id }}">
  <input type="hidden" name="state"  value="{{ state }}">
  <input class="input-text" type="text" name="notes" value="{{ notes }}" size="60">
  <button type="submit" class="piln-btn piln-btn-secondary">Update Notes</button>
</form>

<h3 class="mt-3">PID Settings</h3>
<p>Proportional: {{ profile['p_param'] }} &nbsp;&nbsp; Integral: {{ profile['i_param'] }} &nbsp;&nbsp; Derivative: {{ profile['d_param'] }}</p>
<table class="table-fixed table-segments mt-2">
  <thead>
    <tr>
      <th>Seg</th>
      <th>Trg &deg;C</th>
      <th>&deg;C/hr</th>
      <th>Hold Min</th>
      <th>Int Sec</th>
      <th>Start Time</th>
      <th>End Time</th>
    </tr>
  </thead>
  <tbody>
  {% for segment in segments %}
    <tr data-segment="{{ segment['segment'] }}">
      <td>{{ segment['segment'] }}</td>
      <td>{{ segment['set_temp'] }}</td>
      <td>{{ segment['rate'] }}</td>
      <td>{{ segment['hold_min'] }}</td>
      <td>{{ segment['int_sec'] }}</td>
      <td class="start-time">{{ segment['start_time'] }}</td>
      <td class="end-time">{{ segment['end_time'] }}</td>
    </tr>
  {% endfor %}
  </tbody> 
</table>

<br>
<script>
async function refreshTimes(runId) {
  try {
    const resp = await fetch(`/run/${runId}/times`);
    if (!resp.ok) return;
    const data = await resp.json();

    data.segments.forEach(seg => {
      const row = document.querySelector(`tr[data-segment="${seg.segment}"]`);
      if (row) {
        const startCell = row.querySelector(".start-time");
        const endCell = row.querySelector(".end-time");
        if (startCell) startCell.textContent = seg.start_time || "";
        if (endCell) endCell.textContent = seg.end_time || "";
      }
    });
  } catch (err) {
    console.error("Failed to refresh times", err);
  }
}

// refresh every 15s
setInterval(() => refreshTimes({{ run_id }}), 15000);
</script>
