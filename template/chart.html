<canvas id="myChart"></canvas>
<script src="../style/js/chart.min.js"></script>
<script>
let myChart, lastIso=null;
const run_id = "{{ run_id }}";          // keep your template var
const POLL_MS = 30000, MAX_POINTS=5000; // optional cap

async function fetchDelta(since=null){
  const res = await fetch('/api/data',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ run_id, since })
  });
  if(!res.ok) throw new Error('fetch failed');
  return res.json();
}

function buildChart(d){
  const ctx = document.getElementById('myChart').getContext('2d');
  myChart = new Chart(ctx, {
    type:'line',
    data:{
      labels:d.dt_label,
      datasets:[
        {label:'Temperature', yAxisID:'y1', fill:false, borderColor:'#ff8000', data:d.temp},
        {label:'Target Temperature', yAxisID:'y1', fill:false, borderColor:'#ff0000', data:d.set_temp},
        {label:'PID Output', yAxisID:'y1', type:'bar', borderColor:'#33cc33', backgroundColor:'#33cc33', data:d.pid_output},
        {label:'Segment', yAxisID:'y2', fill:false, borderColor:'#0033cc', data:d.segment},
      ]
    },
    options:{
      interaction:{mode:'nearest'},
      elements:{point:{radius:0},
		line:{tension:0.25}
	},
      animation:{duration:0},
      scales:{
        y1:{type:'linear', position:'left', title:{display:true,text:'Temperature'}},
        y2:{type:'linear', position:'right', grid:{drawOnChartArea:false}, ticks:{stepSize:1}, title:{display:true,text:'Segments'}}
      }
    }
  });
}

function appendDelta(d){
  if(!d || !d.dt_label || d.dt_label.length===0) return;
  myChart.data.labels.push(...d.dt_label);
  myChart.data.datasets[0].data.push(...d.temp);
  myChart.data.datasets[1].data.push(...d.set_temp);
  myChart.data.datasets[2].data.push(...d.pid_output);
  myChart.data.datasets[3].data.push(...d.segment);

  if(myChart.data.labels.length>MAX_POINTS){
    const cut=myChart.data.labels.length-MAX_POINTS;
    myChart.data.labels.splice(0,cut);
    for(const ds of myChart.data.datasets) ds.data.splice(0,cut);
  }
  myChart.update('none');
}

(async function init(){
  const initial = await fetchDelta(null);   // full load once
  buildChart(initial);
  lastIso = initial.last_iso || null;
  setInterval(async ()=>{
    try{
      const d = await fetchDelta(lastIso);
      appendDelta(d);
      if(d.last_iso) lastIso = d.last_iso;
    }catch(e){ console.error(e); }
  }, POLL_MS);
})();
</script>
