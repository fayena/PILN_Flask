<div class="piln-actions">
  <a class="piln-btn piln-btn-secondary" href="/view?run_id={{ run_id }}&state={{ state }}&notes={{ notes|urlencode }}">← Back</a>
</div>

<form method="post" class="piln-form">

  <!-- Hidden fields shared by both submit actions -->
  <input type="hidden" name="run_id" value="{{ run_id }}">
  <input type="hidden" name="lastseg" value="{{ lastseg }}">

  <!-- TOP ACTION BAR -->
  <div class="piln-actions">
    {% if state == 'Staged' %}
      <button type="submit" class="piln-btn" formaction="/saveupd">Update Profile</button>
    {% endif %}
    <button type="submit" class="piln-btn" formaction="/savenew">Save to New Profile</button>
    <a class="piln-btn piln-btn-secondary" href="/view?run_id={{ run_id }}&state={{ state }}&notes={{ notes|urlencode }}">Cancel</a>
  </div>

  <h2>Edit/Copy Profile</h2>

  <!-- Notes + PID row -->
  <div class="form-row">
    <label for="notes"><strong>Notes:</strong></label>
    <input id="notes" name="notes" class="input-text" type="text" value="{{ profile['notes'] }}" size="60">
  </div>

  <div class="form-row">
    <strong>PID Settings:</strong>
    <label for="Kp" class="sr-only">Proportional (Kp)</label>
    <input id="Kp" name="Kp" class="input-text" type="text" value="{{ profile['p_param'] }}" size="6" placeholder="Kp">
    <label for="Ki" class="sr-only">Integral (Ki)</label>
    <input id="Ki" name="Ki" class="input-text" type="text" value="{{ profile['i_param'] }}" size="6" placeholder="Ki">
    <label for="Kd" class="sr-only">Derivative (Kd)</label>
    <input id="Kd" name="Kd" class="input-text" type="text" value="{{ profile['d_param'] }}" size="6" placeholder="Kd">
  </div>

  <!-- Segments table -->
  <table class="table table-fixed table-segments">
    <thead>
      <tr>
        <th>Segment</th>
        <th>Target&nbsp;°C</th>
        <th>Rate&nbsp;(°C/hr)</th>
        <th>Hold&nbsp;Minutes</th>
        <th>Interval&nbsp;Seconds</th>
      </tr>
    </thead>
    <tbody>
      {# Existing segments (1..N) — use loop.index so names are 1..N #}
      {% for segment in segments %}
      <tr>
        <td>{{ loop.index }}</td>
        <td><input class="input-text" type="text" name="set_temp{{ loop.index }}" value="{{ segment['set_temp'] }}" size="6"></td>
        <td><input class="input-text" type="text" name="rate{{ loop.index }}" value="{{ segment['rate'] }}" size="6"></td>
        <td><input class="input-text" type="text" name="hold_min{{ loop.index }}" value="{{ segment['hold_min'] }}" size="6"></td>
        <td><input class="input-text" type="text" name="int_sec{{ loop.index }}" value="{{ segment['int_sec'] }}" size="6"></td>
      </tr>
      {% endfor %}

      {# Extra blank rows (N+1..max) — names use the numeric segment variable #}
      {% for segno in addsegs %}
      <tr>
        <td>{{ segno }}</td>
        <td><input class="input-text" type="text" name="set_temp{{ segno }}" size="6" placeholder="—"></td>
        <td><input class="input-text" type="text" name="rate{{ segno }}" size="6" placeholder="—"></td>
        <td><input class="input-text" type="text" name="hold_min{{ segno }}" size="6" placeholder="—"></td>
        <td><input class="input-text" type="text" name="int_sec{{ segno }}" size="6" placeholder="—"></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- BOTTOM ACTION BAR (optional but handy) -->
  <div class="piln-actions mt-2">
    {% if state == 'Staged' %}
      <button type="submit" class="piln-btn" formaction="/saveupd">Update Profile</button>
    {% endif %}
    <button type="submit" class="piln-btn" formaction="/savenew">Save to New Profile</button>
    <a class="piln-btn piln-btn-secondary" href="/view?run_id={{ run_id }}&state={{ state }}&notes={{ notes|urlencode }}">Cancel</a>
  </div>

</form>
